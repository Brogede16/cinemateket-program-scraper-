<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Cinemateket Programudtræk</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; color: #333; }
        
        /* UI Controls (Hidden on Print) */
        .controls { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; gap: 20px; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 0.85em; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #e31836; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Layout */
        .series-block { margin-bottom: 40px; page-break-inside: avoid; }
        .series-header { margin-bottom: 20px; border-bottom: 2px solid #e31836; padding-bottom: 10px; }
        .series-title { font-size: 1.8em; margin: 0; color: #e31836; }
        .series-meta { display: flex; gap: 20px; margin-top: 15px; }
        .series-banner { width: 150px; height: auto; object-fit: cover; border-radius: 4px; }
        .series-intro { font-style: italic; font-size: 0.95em; color: #555; max-width: 700px; }

        /* Grid */
        .items-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .film-card { border: 1px solid #ddd; border-radius: 6px; padding: 10px; break-inside: avoid; page-break-inside: avoid; background: white; }
        .film-img { width: 100%; height: 160px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; background: #eee; }
        .film-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; min-height: 1.2em; }
        .film-desc { font-size: 0.85em; color: #666; margin-bottom: 10px; line-height: 1.4; height: 4.2em; overflow: hidden; } /* Fixed height ~3 lines */
        .film-dates { font-size: 0.85em; border-top: 1px solid #eee; padding-top: 8px; }
        .date-badge { display: inline-block; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin: 2px; font-weight: 500; }

        .loader { display: none; color: #e31836; font-weight: bold; margin-left: 10px; }

        @media print {
            .controls, h1 { display: none !important; }
            body { padding: 0; margin: 0; font-size: 11pt; -webkit-print-color-adjust: exact; }
            .items-grid { display: block; } /* Fallback for browsers bad at grid print */
            .items-grid { display: flex; flex-wrap: wrap; margin: 0 -10px; }
            .film-card { width: 31%; margin: 10px; box-sizing: border-box; }
        }
    </style>
</head>
<body>

    <h1>Cinemateket Program Generator</h1>

    <div class="controls">
        <div class="control-group">
            <label>Start Dato</label>
            <input type="date" id="start">
        </div>
        <div class="control-group">
            <label>Slut Dato</label>
            <input type="date" id="end">
        </div>
        <div class="control-group">
            <button onclick="fetchProgram()" id="btn">Hent Program</button>
        </div>
        <div class="loader" id="loader">Henter data fra DFI (kan tage 15-30 sekunder)...</div>
    </div>

    <div id="output"></div>

    <script>
        // Sæt default datoer (i dag -> 1 måned frem)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('start').value = today;
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        document.getElementById('end').value = nextMonth.toISOString().split('T')[0];

        async function fetchProgram() {
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const btn = document.getElementById('btn');
            const loader = document.getElementById('loader');
            const output = document.getElementById('output');

            btn.disabled = true;
            loader.style.display = 'inline-block';
            output.innerHTML = '';

            try {
                // Kald API'et (din Flask app)
                const res = await fetch(`/program?mode=range&from=${start}&to=${end}`);
                if (!res.ok) throw new Error("Kunne ikke hente data");
                const data = await res.json();

                if (!data.series || data.series.length === 0) {
                    output.innerHTML = '<p>Ingen visninger fundet i denne periode.</p>';
                    return;
                }

                // Render HTML
                let html = '';
                
                // Header til print
                html += `<div style="margin-bottom:20px; font-size:1.5em; font-weight:bold; display:none;" class="print-header">Program: ${start} til ${end}</div>`;

                data.series.forEach(serie => {
                    html += `
                    <div class="series-block">
                        <div class="series-header">
                            <h2 class="series-title">${serie.name}</h2>
                            ${serie.intro || serie.banner ? `
                            <div class="series-meta">
                                ${serie.banner ? `<img src="${serie.banner}" class="series-banner">` : ''}
                                ${serie.intro ? `<div class="series-intro">${serie.intro}</div>` : ''}
                            </div>` : ''}
                        </div>
                        <div class="items-grid">
                    `;

                    serie.items.forEach(item => {
                        const dateHtml = item.dates.map(d => {
                            // Format: "2023-11-25 16:30" -> "25. nov 16:30"
                            const [dPart, tPart] = d.split(' ');
                            const dateObj = new Date(dPart);
                            const day = dateObj.getDate();
                            const months = ['jan','feb','mar','apr','maj','jun','jul','aug','sep','okt','nov','dec'];
                            return `<span class="date-badge">${day}. ${months[dateObj.getMonth()]} ${tPart}</span>`;
                        }).join('');

                        html += `
                            <div class="film-card">
                                ${item.image ? `<img src="${item.image}" class="film-img">` : ''}
                                <div class="film-title">${item.title}</div>
                                <div class="film-desc">${item.synopsis || ''}</div>
                                <div class="film-dates">${dateHtml}</div>
                            </div>
                        `;
                    });

                    html += `</div></div>`; // End grid & block
                });

                output.innerHTML = html;

            } catch (err) {
                output.innerHTML = `<p style="color:red">Fejl: ${err.message}</p>`;
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>
